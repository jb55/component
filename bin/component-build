#!/usr/bin/env node

/**
 * Module dependencies.
 */

var program = require('commander')
  , Builder = require('component-builder')
  , requirejs = require('component-require')
  , Batch = require('batch')
  , component = require('..')
  , utils = component.utils
  , log = component.utils.log
  , path = require('path')
  , fs = require('fs')
  , mkdir = require('mkdirp');

// options

program
  .option('-d, --dev', 'build development dependencies')
  .option('-s, --standalone <name>', 'build a stand-alone version of the component')
  .option('-o, --out <dir>', 'output directory defaulting to ./build', 'build')
  .option('-n, --name <file>', 'base name for build files defaulting to build', 'build')
  .option('-f, --fileName <file>', 'output filename, works best with -c and -j')
  .option('-v, --verbose', 'output verbose build information')
  .option('-p, --prefix <str>', 'prefix css asset urls with <str>')
  .option('--css', 'build css')
  .option('--js', 'build js')
  .option('-c, --copy', 'copy files instead of linking')

// examples

program.on('--help', function(){
  console.log('  Examples:');
  console.log();
  console.log('    # build to ./build');
  console.log('    $ component build');
  console.log();
  console.log('    # build to ./dist as assets.js, assets.css');
  console.log('    $ component build -o dist -n assets');
  console.log();
  console.log('    # build standalone as window.$');
  console.log('    $ component build --standalone $');
  console.log();
});

// parse argv

program.parse(process.argv);

// load json

var conf = require(path.resolve('component.json'));

// standalone

var standalone = program.standalone;

// output paths

var jsPath = path.join(program.out, program.fileName || program.name + '.js');
var cssPath = path.join(program.out, program.fileName || program.name + '.css');

// mkdir -p

mkdir.sync(program.out);

// build

var builder = new Builder(process.cwd());
if (program.copy) builder.copyFiles();
builder.copyAssetsTo(program.out);
if (program.dev) builder.prefixUrls('./');
if (program.prefix) builder.prefixUrls(program.prefix);

// lookup paths

if (conf.paths) builder.addLookup(conf.paths);

var start = new Date;

// --dev

if (program.dev) {
  builder.development();
  builder.addSourceURLs();
}


// js
function buildScripts(err, js, fn){
  if (err) return fn(err)

  var out = '';
  var name = 'string' == typeof standalone
    ? standalone
    : conf.name;

  if (standalone) out += ';(function(){\n';
  out += requirejs;
  out += js;

  if (standalone) {
    var umd = [
      'if (typeof exports == "object") {',
      '  module.exports = require("' + conf.name + '");',
      '} else if (typeof define == "function" && define.amd) {',
      '  define(function(){ return require("' + conf.name + '"); });',
      '} else {',
      '  window["' + name + '"] = require("' + conf.name + '");',
      '}'
    ];

    out += umd.join('\n');
    out += '})();';
  }

  fs.writeFile(jsPath, out);

  if (program.verbose)
    log('write', jsPath);
    log('js', (out.length / 1024 | 0) + 'kb');

  fn(null, js);
}


// css
function buildStyles(fn){
  builder.buildStyles(function(err, css){
    if (err) return fn(err);
    var css = css.trim();

    if (program.verbose)
      log('write', cssPath);
      log('css', (css.length / 1024 | 0) + 'kb');

    fs.writeFile(cssPath, css);

    fn(null, css);
  });
}

// build

if (program.verbose) console.log();

var buildables = ["js", "css"]
  , toBuild = []
  , batch = new Batch
  , builders = {
      js: function(fn){
        var b = new Batch
        b.push(builder.buildScripts.bind(builder))
        b.push(builder.buildAliases.bind(builder))
        b.end(function(err, res){
          if (err) throw err;
          var js = res.shift() + '\n' + res.shift() + '\n' + builder._js;
          buildScripts(err, js, fn);
        });
      }
    , css: buildStyles
  };

// look for specific build flags
buildables.forEach(function(buildable){
  if (program[buildable])
    toBuild.push(buildable);
});

// if no specific build flags, build everything
if (toBuild.length === 0)
  toBuild = buildables;

// push buildables into our batch
toBuild.forEach(function(buildable){
  batch.push(builders[buildable]);
});

if (program.verbose)
  log('building', toBuild)

// run the batch
batch.end(function(err){
  if (err) utils.fatal(err);
  if (!program.verbose) return;
  var duration = new Date - start;
  log('duration', duration + 'ms');
  console.log();
});

